This course is prepared by Wojciech Domski.
All rights reserved.

# Prerequisites

Remember to add *printf()* redirection.
Also do not forget to turn off optimization and 
set parallel build e.g. for 8 simultaneous threads.
Create a launch debug configuration that 
will only flash the MCU without entering debug mode.

# Task 1

Import **DAC_ex1** project into Atollic TrueSTUDIO.
The aim of this exercise is to show how basic DAC 
conversion works. 

This application is using three peripherals.
1. DAC (DAC1) is used to convert digital value of 
a sampled sine wave to its analog representation.
2. ADC (ADC1) measures the value generated by the DAC.
3. TIM (TIM6) in time base mode is used to periodically 
trigger DAC to convert next sample and 
launch ADC measurement.

Below you can see an example of an output:
```
2293
2128
1967
1811
1651
1491
1345
1186
1041
895
771
641
```

You have to connect two pins with a wire. Pin PA0 (analog input) 
and PA4 (analog output). Connect those two ports 
while the dev board is not connected to power!
Use the leaflet given out during classes to identify the 
MCU pins.
Before proceeding further inform teacher about the connection 
and ask for permission to proceed further.

During the implementation use provided variables: **flag**, 
**measurement**, **tim_ticks** and  **sample_index** 
and **dac_waveform[]**.

In this task you have to fill out following gaps:

- implement the corresponding callback function for DAC 
(send a new value to DAC output, move to next sample from 
**dac_waveform[]** array using **sample_index** variable, 
trigger ADC measurement in interrupt mode),
- implement the corresponding callback function for ADC 
(set **flag** and read measured value),
- initialize DAC value and start this peripheral at the beginning 
of the application,
- initialize TIM in time base mode with interrupts.

## Data visualization

Use STMStudio software to visualize the measured value.
Open STMStudio and import variables from executable (*.elf file).
Start recording session. Remember to disconnect from ST-Link Utility 
and terminate any open debug session in Atollic TrueSTUDIO.
More information about STMStudio can be found in [UM1025].


# Useful functions

Start ADC conversion in interrupt mode.
- HAL_ADC_Start_IT(&hadc1);

Callback function called when the ADC measurement is ready.
- void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc);

Returns last measured value.
- measurement = HAL_ADC_GetValue(&hadc1);

Sets DAC desired value, in this example it is 0.
- HAL_DAC_SetValue(&hdac1, DAC_CHANNEL_1, DAC_ALIGN_8B_R, 0);

Starts DAC peripheral.
- HAL_DAC_Start(&hdac1, DAC_CHANNEL_1);

Starts timer in time base mode with interrupts.
- HAL_TIM_Base_Start_IT(&htim6);

Get current number of ticks measured since 
MCU start (in this exercise 1 tick = 1 [ms])
- HAL_GetTick();

Redirection of printf() function output to serial port 
can be done with redefinition of _write() function.
Also include **stdio.h**.

```
int _write(int file, char *ptr, int len) {
	HAL_UART_Transmit(&huart2, (uint8_t *) ptr, len, 50);
	return len;
}
```
