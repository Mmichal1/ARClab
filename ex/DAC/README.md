This course is prepared by Wojciech Domski.
All rights reserved.

# Prerequisites

Remember to add *printf()* redirection.
Also do not forget to turn off optimization and 
set parallel build e.g. for 8 simultaneous threads.
Create a launch debug configuration that 
will only flash the MCU without entering debug mode.

# Task 1

Import **DAC_ex1** project into IDE.
The aim of this exercise is to show how DAC 
conversion works. 

This application is using three peripherals:
1. DAC (DAC1) is used to convert digital value of 
a sampled sine wave to its analog representation.
2. ADC (ADC1) measures the value generated by the DAC.
3. TIM (TIM6) in time base mode is used to periodically 
trigger DAC to convert next sample and 
launch ADC measurement.

Below you can see an example of an output:
```
2293
2128
1967
1811
1651
1491
1345
1186
1041
895
771
641
```

Two connectors are being used:
- **DAC1** DAC output,
- **ADC1** ADC input.
Both connectors are connected via a low-pass filter.

During the implementation use provided variables: 
- **flag** notification about ADC conversion event, 
- **measurement** holds measured ADC value on **ADC1**, 
- **tim_ticks** holds current number of timer's ticks,
- **dac_waveform[]** an array holding a sinus wave for 
DAC generator.
- **sample_index** index to move over **dac_waveform** array.

The **tim_ticks** is being used to adjust the 
DAC wave generator frequency. The timer base frequency is 
set to 1kHz. The maximum allowed value of **tim_ticks**
and length of **dac_waveform[]** define the resulting 
frequency of generated sinus wave.

In this task you have to fill out following gaps:

- implement the corresponding callback function for DAC 
(send a new value to DAC output, move to next sample from 
**dac_waveform[]** array using **sample_index** variable, 
trigger ADC measurement in interrupt mode),
- implement the corresponding callback function for ADC 
(set **flag** and read measured value),
- initialize DAC value and start this peripheral at the beginning 
of the application,
- initialize TIM in time base mode with interrupts.

## Data visualization

Use STMStudio software to visualize the measured value.
Open STMStudio and import variables from executable (*.elf file).
Start recording session. Remember to disconnect from ST-Link Utility 
and terminate any open debug session in Atollic TrueSTUDIO.
More information about STMStudio can be found in [UM1025].


# Useful functions

Start ADC conversion in interrupt mode.
```C
HAL_ADC_Start_IT(&hadc1);
```

Callback function called when the ADC measurement is ready.
```C
- void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc);
```

Returns last measured value.
```C
measurement = HAL_ADC_GetValue(&hadc1);
```

Sets DAC desired value, in this example it is 0. 
Please mind the resolution of DAC. It is set to 
8 bits and it is consistent with **dac_waveform[]** 
data type and aliment.
```C
HAL_DAC_SetValue(&hdac1, DAC_CHANNEL_1, DAC_ALIGN_8B_R, 0);
```

Starts DAC peripheral.
```C
HAL_DAC_Start(&hdac1, DAC_CHANNEL_1);
```

Starts timer in time base mode with interrupts.
```C
HAL_TIM_Base_Start_IT(&htim6);
```

Get current number of ticks measured since 
MCU start (in this exercise 1 tick = 1 [ms])
```C
HAL_GetTick();
```

Redirection of **printf()** function output to serial port 
can be done with redefinition of *_write()* function.
Also include **stdio.h**.

```
int _write(int file, char *ptr, int len) {
	HAL_UART_Transmit(&huart2, (uint8_t *) ptr, len, 50);
	return len;
}
```
